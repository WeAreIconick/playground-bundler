(()=>{"use strict";var e={n:n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},d:(n,t)=>{for(var r in t)e.o(t,r)&&!e.o(n,r)&&Object.defineProperty(n,r,{enumerable:!0,get:t[r]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};const n=window.React,t=window.wp.plugins,r=window.wp.editor,l=window.wp.components,a=window.wp.element,o=window.wp.data,d=window.wp.blockEditor,s=window.wp.i18n,i=window.wp.apiFetch;var u=e.n(i);(0,t.registerPlugin)("playground-bundler",{render:()=>{const[e,t]=(0,a.useState)(!1),[i,c]=(0,a.useState)(!1),[p,g]=(0,a.useState)([]),[y,m]=(0,a.useState)([]),[b,_]=(0,a.useState)(null),[w,f]=(0,a.useState)(null),[E,h]=(0,a.useState)(!1),[B,P]=(0,a.useState)(null),{postId:k,blocks:S}=(0,o.useSelect)(e=>({postId:e("core/editor").getCurrentPostId(),blocks:e(d.store).getBlocks()}),[]),x=(0,a.useCallback)(async()=>{if(k){c(!0),f(null);try{const e=await u()({url:playgroundBundler.restUrl+"analyze/"+k,method:"GET",headers:{"X-WP-Nonce":playgroundBundler.nonce}});e.success&&(_(e.data),g(e.data.blocks||[]),m(e.data.media_types||[]))}catch(e){f(e.message||(0,s.__)("Failed to analyze content.","playground-bundler"))}finally{c(!1)}}},[k]);(0,a.useEffect)(()=>{S&&S.length>0&&k&&x()},[S,k,x]);const v=Array.isArray(p)?p.filter(e=>!e.startsWith("core/")):[],C=v.length>0,N=!!Array.isArray(y)&&y.length>0;return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(r.PluginSidebarMoreMenuItem,{target:"playground-bundler-sidebar"},(0,s.__)("Playground Bundler","playground-bundler")),(0,n.createElement)(r.PluginSidebar,{name:"playground-bundler-sidebar",title:(0,s.__)("WordPress Playground Bundler","playground-bundler"),icon:"download"},(0,n.createElement)(l.PanelBody,{title:(0,s.__)("Detected Content","playground-bundler"),initialOpen:!0},i&&(0,n.createElement)("div",{style:{display:"flex",alignItems:"center",marginBottom:"16px"}},(0,n.createElement)(l.Spinner,null),(0,n.createElement)("span",{style:{marginLeft:"8px"}},(0,s.__)("Analyzing content…","playground-bundler"))),w&&(0,n.createElement)(l.Notice,{status:"error",isDismissible:!1},w),(0,n.createElement)("div",{style:{marginBottom:"16px"}},(0,n.createElement)("strong",null,(0,s.__)("Blocks:","playground-bundler")),(0,n.createElement)("p",{style:{fontSize:"13px",color:"#757575"}},p.length>0?`${p.length} block type(s) detected`:(0,s.__)("No blocks detected","playground-bundler")),C&&(0,n.createElement)(l.Notice,{status:"info",isDismissible:!1},(0,n.createElement)("strong",null,(0,s.__)("Custom blocks found:","playground-bundler")),(0,n.createElement)("ul",{style:{marginTop:"8px",paddingLeft:"20px"}},v.map(e=>(0,n.createElement)("li",{key:e,style:{fontSize:"12px"}},e))))),(0,n.createElement)("div",{style:{marginBottom:"16px"}},(0,n.createElement)("strong",null,(0,s.__)("Media Assets:","playground-bundler")),(0,n.createElement)("p",{style:{fontSize:"13px",color:"#757575"}},b?.media_count>0?`${b.media_count} asset(s) detected`:(0,s.__)("No media assets detected","playground-bundler")),N&&Array.isArray(y)&&(0,n.createElement)("ul",{style:{paddingLeft:"20px",fontSize:"12px"}},y.map((e,t)=>(0,n.createElement)("li",{key:t},e&&"string"==typeof e?e.charAt(0).toUpperCase()+e.slice(1):e," ","files"))))),(0,n.createElement)(l.PanelBody,{title:(0,s.__)("Generate Blueprint","playground-bundler"),initialOpen:!0},(0,n.createElement)("p",{style:{fontSize:"13px",marginBottom:"16px"}},(0,s.__)("Create a WordPress Playground blueprint bundle containing all blocks, plugins, and media assets from this page.","playground-bundler")),E?(0,n.createElement)("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},(0,n.createElement)(l.Notice,{status:"success",isDismissible:!1},(0,s.__)("Bundle generated successfully!","playground-bundler")),(0,n.createElement)(l.Button,{variant:"primary",onClick:async()=>{if(B)try{const e=await fetch(B.blueprint_url,{method:"GET",headers:{"X-WP-Nonce":playgroundBundler.nonce}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const n=await e.text();if(!n.trim().endsWith("}"))throw new Error("Response appears to be truncated or corrupted");const t=JSON.parse(n),r=JSON.stringify(t,null,2),l=new Blob([r],{type:"application/json"}),a=window.URL.createObjectURL(l),o=document.createElement("a");o.href=a,o.download=B.bundle_name+"-blueprint.json",o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(a)}catch(e){console.error("Playground Bundler: Download error:",e),console.error("Playground Bundler: Error details:",{message:e.message,status:e.status,code:e.code,data:e.data}),f((0,s.__)("Download failed: "+(e.message||"Unknown error"),"playground-bundler"))}},style:{width:"100%"}},(0,s.__)("Download Bundle","playground-bundler")),(0,n.createElement)(l.Button,{variant:"secondary",onClick:()=>{if(B)try{const e="https://playground.wordpress.net/?blueprint-url="+encodeURIComponent(B.blueprint_url);window.open(e,"_blank","noopener,noreferrer")}catch(e){console.error("Playground Bundler: Error opening in playground:",e),f("Failed to open in WordPress Playground. Please try downloading the file instead.")}},style:{width:"100%"}},(0,s.__)("Open in Playground","playground-bundler")),(0,n.createElement)(l.Button,{variant:"tertiary",onClick:()=>{h(!1),P(null),f(null)},style:{width:"100%",fontSize:"12px"}},(0,s.__)("Generate New Bundle","playground-bundler"))):(0,n.createElement)(l.Button,{variant:"primary",onClick:async()=>{if(k){t(!0),f(null),h(!1),P(null);try{const e=await u()({url:playgroundBundler.restUrl+"bundle/"+k,method:"POST",headers:{"X-WP-Nonce":playgroundBundler.nonce}});if(!e.success)throw new Error(e.message||(0,s.__)("Failed to generate bundle.","playground-bundler"));P(e.data),h(!0),f(null)}catch(e){let n=(0,s.__)("Failed to generate bundle.","playground-bundler");console.error("Playground Bundler: Bundle generation error:",e),429===e.status?n=(0,s.__)("Too many requests. Please wait 30 seconds before trying again.","playground-bundler"):403===e.status?n=(0,s.__)("Permission denied. Please refresh the page and try again.","playground-bundler"):500===e.status?n=(0,s.__)("Server error. Please try again in a moment.","playground-bundler"):e.message&&(n=e.message.includes("rate_limit")?(0,s.__)("Too many requests. Please wait before trying again.","playground-bundler"):e.message.includes("file_too_large")?(0,s.__)("Bundle too large. Please reduce content or media files.","playground-bundler"):e.message.includes("permission")?(0,s.__)("You do not have permission to generate bundles.","playground-bundler"):e.message),f(n),h(!1)}finally{t(!1)}}},isBusy:e,disabled:e||!k,style:{width:"100%",marginBottom:"12px"}},e?(0,s.__)("Generating Bundle…","playground-bundler"):(0,s.__)("Generate Bundle","playground-bundler")),!k&&(0,n.createElement)(l.Notice,{status:"warning",isDismissible:!1},(0,s.__)("Please save the post before generating a bundle.","playground-bundler")))))},icon:"download"})})();